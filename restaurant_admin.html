<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Admin - Yummy</title>
    <link rel="stylesheet" href="css/restaurant_admin.css">
</head>
<body>
    <header class="navbar">
        <div class="logo">Yummy - Restaurant Admin</div>
        <button class="logout-btn" onclick="logout()" style="display: none;" id="logout-btn">Logout</button>
    </header>

    <div class="container">
        <div class="auth-section" id="auth-section">
            <h2>Restaurant Portal</h2>
            <div class="auth-tabs">
                <button class="tab-btn active" onclick="switchTab('login')">Login</button>
                <button class="tab-btn" onclick="switchTab('signup')">Sign Up</button>
            </div>

            <form class="auth-form active" id="login-form">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" id="login-email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-control" id="login-password" required>
                </div>
                <button type="submit" class="submit-btn">Login</button>
            </form>

            <form class="auth-form" id="signup-form">
                <div class="form-group">
                    <label>Restaurant Name</label>
                    <input type="text" class="form-control" id="signup-name" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" id="signup-email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-control" id="signup-password" required>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" class="form-control" id="signup-phone" required>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea class="form-control" id="signup-address" rows="3" required></textarea>
                </div>
                <button type="submit" class="submit-btn">Sign Up</button>
            </form>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <h2 id="restaurant-name">Welcome!</h2>
                <span class="restaurant-status" id="restaurant-status"></span>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3 class="card-title">ðŸ“‹ Current Menu Items</h3>
                    <div id="menu-items-list">
                        <p style="color: #666; text-align: center; padding: 2rem;">No menu items yet. Add your first item!</p>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3 class="card-title">âž• Add New Menu Item</h3>

                    <form class="add-item-form" id="add-item-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label>Item Name</label>
                            <input type="text" class="form-control" id="item-name" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="form-control" id="item-description" rows="3" required></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Price ($)</label>
                                <input type="number" class="form-control" id="item-price" step="0.01" required>
                            </div>
                            <div class="form-group full-width">
                                <label>Item Image</label>
                                <div class="image-upload-container">
                                  <label for="item-image" class="image-upload-label">
                                    <i class="fas fa-camera"></i>
                                    <span id="image-file-name">Choose an image...</span>
                                  </label>
                                  <input type="file" id="item-image" accept="image/*" style="display:none;">
                                  <div class="image-preview" id="image-preview"></div>
                                </div>
                              </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select class="form-control" id="item-category" required>
                                    <option value="">Select Category</option>
                                    <option value="appetizer">Appetizer</option>
                                    <option value="main">Main Course</option>
                                    <option value="dessert">Dessert</option>
                                    <option value="beverage">Beverage</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="submit-btn">Add Item</button>
                    </form>
                </div>

                <div class="dashboard-card">
                    <h3 class="card-title">ðŸ“¦ Current Orders</h3>
                    <div id="orders-list">
                        <p style="color: #666; text-align: center; padding: 2rem;">No current orders</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // ==================== RESTAURANT ADMIN FUNCTIONALITY ====================
let currentUser = null;
let restaurants = [];
let orders = [];
let orderNotificationCount = 0;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize restaurant data
    if (!window.restaurantData) {
        try {
            const storedData = localStorage.getItem('restaurantData');
            window.restaurantData = storedData ? JSON.parse(storedData) : [];
        } catch (e) {
            console.error("Error initializing restaurant data:", e);
            window.restaurantData = [];
        }
    }

    restaurants = loadRestaurantData();
    orders = loadOrders();
    
    // Check for logged in user
    const userId = localStorage.getItem('currentUserId');
    if (userId) {
        currentUser = restaurants.find(r => r.id === Number(userId));
        if (currentUser) showDashboard();
    }
    
    // Initialize image upload
    handleImageUpload();
    
    // Set up form event listeners
    setupFormEventListeners();
    
    // Set up periodic refresh
    setInterval(refreshData, 2000);
});

// ==================== DATA FUNCTIONS ====================
function loadRestaurantData() {
    try {
        const data = localStorage.getItem('restaurantData');
        return data ? JSON.parse(data) : [];
    } catch (e) {
        console.error("Error loading restaurant data:", e);
        return [];
    }
}

function saveRestaurantData(data) {
    try {
        window.restaurantData = data;
        localStorage.setItem('restaurantData', JSON.stringify(data));
        window.dispatchEvent(new Event('restaurantDataUpdated'));
    } catch (e) {
        console.error("Error saving restaurant data:", e);
    }
}

function loadOrders() {
    try {
        const savedOrders = localStorage.getItem('restaurantOrders');
        return savedOrders ? JSON.parse(savedOrders) : [];
    } catch (e) {
        console.error("Error loading orders:", e);
        return [];
    }
}

// ==================== AUTH FUNCTIONS ====================
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab + '-form').classList.add('active');
}

function setupFormEventListeners() {
    // Signup form
    document.getElementById('signup-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const phone = document.getElementById('signup-phone').value;
        const address = document.getElementById('signup-address').value;

        if (restaurants.find(r => r.email === email)) {
            showNotification('Restaurant with this email already exists!', 'error');
            return;
        }

        const newRestaurant = {
            id: Date.now(),
            name,
            email,
            password,
            phone,
            address,
            approved: false,
            rejected: false,
            menuItems: [],
            createdAt: new Date().toISOString()
        };

        restaurants.push(newRestaurant);
        saveRestaurantData(restaurants);
        
        showNotification('Registration successful! Waiting for admin approval.');
        this.reset();
        switchTab('login');
    });

    // Login form
    document.getElementById('login-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        const restaurant = restaurants.find(r => r.email === email && r.password === password);
        
        if (!restaurant) {
            showNotification('Invalid email or password!', 'error');
            return;
        }

        if (restaurant.rejected) {
            showNotification('Your application was rejected. Please contact support.', 'error');
            return;
        }

        currentUser = restaurant;
        localStorage.setItem('currentUserId', currentUser.id);
        showDashboard();
        showNotification('Login successful!');
    });

    // Add menu item form
    document.getElementById('add-item-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentUser?.approved) {
            showNotification('You can only add menu items after approval!', 'error');
            return;
        }

        const imageInput = document.getElementById('item-image');
        let imageUrl = '';
        
        if (imageInput.files[0]) {
            imageUrl = URL.createObjectURL(imageInput.files[0]); // Temporary local URL
        }

        const newItem = {
            id: Date.now(),
            name: document.getElementById('item-name').value,
            description: document.getElementById('item-description').value,
            price: parseFloat(document.getElementById('item-price').value),
            category: document.getElementById('item-category').value,
            image: imageUrl,
            createdAt: new Date().toISOString()
        };

        if (!newItem.name || !newItem.description || isNaN(newItem.price) || !newItem.category) {
            showNotification('Please fill all fields correctly!', 'error');
            return;
        }

        currentUser.menuItems = currentUser.menuItems || [];
        currentUser.menuItems.push(newItem);
        
        const index = restaurants.findIndex(r => r.id === currentUser.id);
        if (index !== -1) {
            restaurants[index] = currentUser;
            saveRestaurantData(restaurants);
        }

        renderMenuItems();
        showNotification('Menu item added successfully!');
        this.reset();
        removeImage();
    });
}

// ==================== IMAGE UPLOAD FUNCTIONS ====================
function handleImageUpload() {
    const input = document.getElementById('item-image');
    const preview = document.getElementById('image-preview');
    const fileName = document.getElementById('image-file-name');
    
    input.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            // Validate file type
            if (!file.type.match('image.*')) {
                showNotification('Please select an image file (JPEG, PNG, etc.)', 'error');
                return;
            }
            
            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showNotification('Image size should be less than 2MB', 'error');
                return;
            }

            fileName.textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button class="remove-image-btn" onclick="removeImage()">Remove</button>
                `;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    });
}

function removeImage() {
    document.getElementById('item-image').value = '';
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('image-file-name').textContent = 'Choose an image...';
}

// ==================== DASHBOARD FUNCTIONS ====================
function showDashboard() {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('dashboard').classList.add('active');
    document.getElementById('logout-btn').style.display = 'block';
    updateDashboard();
}

function updateDashboard() {
    if (!currentUser) return;

    document.getElementById('restaurant-name').textContent = currentUser.name;
    
    const statusElement = document.getElementById('restaurant-status');
    if (currentUser.approved) {
        statusElement.textContent = 'APPROVED âœ“';
        statusElement.className = 'restaurant-status status-approved';
    } else if (currentUser.rejected) {
        statusElement.textContent = 'REJECTED âœ—';
        statusElement.className = 'restaurant-status status-rejected';
    } else {
        statusElement.textContent = 'PENDING APPROVAL';
        statusElement.className = 'restaurant-status status-pending';
    }

    renderMenuItems();
    renderOrders();
    checkForNewOrders();
}

// ==================== MENU ITEM FUNCTIONS ====================
function renderMenuItems() {
    const container = document.getElementById('menu-items-list');
    if (!container) return;
    
    if (!currentUser.menuItems || currentUser.menuItems.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No menu items yet. Add your first item!</p>';
        return;
    }

    container.innerHTML = currentUser.menuItems.map(item => `
        <div class="menu-item">
            ${item.image ? `
            <div class="item-image">
                <img src="${item.image}" alt="${item.name}">
            </div>
            ` : ''}
            <div class="item-info">
                <h4>${item.name}</h4>
                <p>${item.description}</p>
                <div class="item-details">
                    <span class="item-price">$${item.price.toFixed(2)}</span>
                    <span class="item-category">${item.category}</span>
                </div>
            </div>
            <button class="delete-btn" onclick="deleteMenuItem(${item.id})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
}

function deleteMenuItem(itemId) {
    if (!confirm('Are you sure you want to delete this menu item?')) return;
    
    currentUser.menuItems = currentUser.menuItems.filter(item => item.id !== itemId);
    
    const index = restaurants.findIndex(r => r.id === currentUser.id);
    if (index !== -1) {
        restaurants[index] = currentUser;
        saveRestaurantData(restaurants);
    }

    renderMenuItems();
    showNotification('Menu item deleted successfully!');
}

// ==================== ORDER FUNCTIONS ====================
function renderOrders() {
    const container = document.getElementById('orders-list');
    if (!container) return;
    
    const restaurantOrders = orders.filter(order => 
        order.restaurantName === currentUser.name && order.status !== 'delivered'
    );
    
    if (restaurantOrders.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No current orders</p>';
        return;
    }
    
    container.innerHTML = restaurantOrders.map(order => `
        <div class="order-item ${order.status}">
            <div class="order-header">
                <span class="order-id">Order #${order.orderId}</span>
                <span class="order-status status-${order.status}">${order.status.toUpperCase()}</span>
            </div>
            <div class="order-details">
                <div><strong>Order Time:</strong> ${new Date(order.orderTime).toLocaleString()}</div>
                <div class="order-item-list">
                    ${order.items.map(item => `
                        <div class="order-item-row">
                            <span>${item.quantity}x ${item.name}</span>
                            <span>$${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="order-total">
                    <strong>Total:</strong> $${order.total.toFixed(2)}
                </div>
                <hr>
                <div class="customer-info">
                    <h4>Customer Information</h4>
                    <p><strong>Name:</strong> ${order.customerInfo.name}</p>
                    <p><strong>Phone:</strong> ${order.customerInfo.phone}</p>
                    <p><strong>Email:</strong> ${order.customerInfo.email}</p>
                    <p><strong>Address:</strong> ${order.customerInfo.address}</p>
                    ${order.customerInfo.instructions ? 
                        `<p><strong>Instructions:</strong> ${order.customerInfo.instructions}</p>` : ''}
                </div>
            </div>
            <div class="order-actions">
                ${order.status === 'received' ? 
                    `<button class="action-btn prepare-btn" onclick="updateOrderStatus(${order.orderId}, 'preparing')">
                        <i class="fas fa-utensils"></i> Start Preparing
                    </button>` : ''}
                ${order.status === 'preparing' ? 
                    `<button class="action-btn ready-btn" onclick="updateOrderStatus(${order.orderId}, 'ready')">
                        <i class="fas fa-check"></i> Mark as Ready
                    </button>` : ''}
                ${order.status === 'ready' ? 
                    `<button class="action-btn complete-btn" onclick="updateOrderStatus(${order.orderId}, 'delivered')">
                        <i class="fas fa-truck"></i> Mark as Delivered
                    </button>` : ''}
            </div>
        </div>
    `).join('');
}

function updateOrderStatus(orderId, newStatus) {
    const orderIndex = orders.findIndex(o => o.orderId === orderId);
    if (orderIndex !== -1) {
        orders[orderIndex].status = newStatus;
        try {
            localStorage.setItem('restaurantOrders', JSON.stringify(orders));
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'restaurantOrders',
                newValue: JSON.stringify(orders)
            }));
            renderOrders();
            showNotification(`Order #${orderId} status updated to ${newStatus}`);
        } catch (e) {
            console.error("Error updating order status:", e);
        }
    }
}

function checkForNewOrders() {
    if (!currentUser) return;
    
    const newOrders = orders.filter(o => 
        o.restaurantName === currentUser.name && o.status === 'received'
    );
    
    if (newOrders.length > orderNotificationCount) {
        const diff = newOrders.length - orderNotificationCount;
        showNotification(`You have ${diff} new order${diff > 1 ? 's' : ''}!`, 'success');
        playNotificationSound();
    }
    
    orderNotificationCount = newOrders.length;
}

// ==================== UTILITY FUNCTIONS ====================
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function playNotificationSound() {
    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
    audio.volume = 0.3;
    audio.play().catch(e => console.log("Audio play failed:", e));
}

function refreshData() {
    const updatedRestaurants = loadRestaurantData();
    if (JSON.stringify(updatedRestaurants) !== JSON.stringify(restaurants)) {
        restaurants = updatedRestaurants;
        if (currentUser) {
            const updatedUser = restaurants.find(r => r.id === currentUser.id);
            if (updatedUser) currentUser = updatedUser;
            updateDashboard();
        }
    }
    
    const updatedOrders = loadOrders();
    if (JSON.stringify(updatedOrders) !== JSON.stringify(orders)) {
        orders = updatedOrders;
        checkForNewOrders();
        renderOrders();
    }
}

function logout() {
    currentUser = null;
    localStorage.removeItem('currentUserId');
    document.getElementById('auth-section').style.display = 'block';
    document.getElementById('dashboard').classList.remove('active');
    document.getElementById('logout-btn').style.display = 'none';
    document.getElementById('login-form').reset();
}

// ==================== GLOBAL FUNCTIONS ====================
window.switchTab = switchTab;
window.deleteMenuItem = deleteMenuItem;
window.updateOrderStatus = updateOrderStatus;
window.logout = logout;
window.removeImage = removeImage;
    </script>
</body>
</html>